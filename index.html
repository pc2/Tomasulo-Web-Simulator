<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#009578">
    <title>Tomasulo-Simulator</title>

    <link rel="stylesheet" href="resources/css/intro.css" />
    <link rel="stylesheet" href="resources/css/main.css" />
    <link rel="stylesheet" href="resources/css/table.css" />
    <link rel="stylesheet" href="resources/css/layout.css" />
    <link rel="stylesheet" href="resources/css/modal.css" />
    <link rel="stylesheet" href="resources/css/inputWindow.css" />

    <script src="resources/jsLibrary/loadash.js"></script>
    <script src="resources/jsLibrary/intro.js"></script>

    <script src="resources/js/utils.js"></script>
    <script src="resources/js/inputs.js"></script>
    <script src="resources/js/settings.js"></script>
    <script src="resources/js/reservation.js"></script>
    <script src="resources/js/funits.js"></script>
    <script src="resources/js/registers.js"></script>
    <!-- <script src="resources/js/controller.js"></script> -->
    <script src="resources/js/Annotation.js"></script>
    <script src="resources/js/antNode.js"></script>
    <script src="resources/js/annotationTree.js"></script>
    <script src="resources/js/instruction.js"></script>
    <script src="resources/js/state.js"></script>
    <script src="resources/js/resourceManager.js"></script>
    <script src="resources/js/processManager.js"></script>
    <script src="resources/js/diagram.js"></script>
</head>


<body onload="ShowComponents()">
    <div class="cMainWrapper">
        <div id="container">

            <div id="hdrContainer" class="cHeadrContainer">
                <h2>Tomasulo-Simulator</h2>
            </div>

            <div id="modalTop" class="modal">
                <button onclick="closeModal()" class="close" title="Close Modal"><img class="closeBtn"
                        src="resources/images/icons/close.png"></button>

                <div class="modalFormContent">
                </div>

            </div>
            <!--modal end-->
            <div id="lContainer" class="cLContainer">

                <div id="inputContainer" class="cInputContainer">


                    <div class="cInputContainerTab cTab">
                        <button class="cInputContainerTabItem cTabButton" id="Instruction"
                            style="background-color: rgb(235, 190, 142);"
                            onclick="TabSelection('InstructionsInput','Instruction')">Instruction</button>
                        <button class="cInputContainerTabItem cTabButton " id="Funits"
                            onclick="TabSelection('FUnitsInput','Funits')">FUnits</button>
                        <button class="cInputContainerTabItem cTabButton" id="Workloads"
                            onclick="TabSelection('Workload','Workloads')">Workload</button>
                    </div>

                    <div id="InstructionsInput" class="cInstructionsInput cInputBody">
                        <table id="insInputTable" class="cIinsInputTable">
                            <tbody id="insInputTBody" class="cInsInputTBody">
                            </tbody>
                        </table>


                        <div id="InstructionInputActionButton" class="cInstructionInputActionButton cInputActionButton">

                            <button class="cInstructionActionButton cNextButton"
                                onclick="ShowFunitSettings()">Next</button>


                            <button class="cInstructionActionButton cLeftInputButton"
                                onclick="LoadTestCase_2()">Test-01</button>
                            <button class="cInstructionActionButton cLeftInputButton"
                                onclick="LoopTestCase_1()">Test-02</button>

                            <button type="button" for='file' class="cInstructionActionButton cLeftInputButton"
                                onclick="LoadFromFile(this)">
                                <!-- <img id="importimg" src="resources/images/icons/import.png"> -->
                                load
                                <input id="file" type="file" name="name" style="display:none;" />
                            </button>

                        </div>

                    </div>

                    <div id="FUnitsInput" class="cFUnitsInput cInputBody " style="display:none">
                        <div class="cCycleSettings">
                            <table id="FUnitsCycleTable" class="cFUnitSettingsTable">
                                <thead>
                                    <tr>
                                        <th>OP</th>
                                        <th>EX Cycles</th>
                                    </tr>

                                </thead>

                                <tbody id="FUnitSettingsTableBody">
                                    <tr>
                                        <td>Load C.Miss</td>

                                        <td>
                                            <input type="text" id="cCyclesFormText" name="ld_miss" value="8">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Load C.Hit</td>

                                        <td>
                                            <input type="text" id="cCyclesFormText" name="ld_hit" value="1">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>store</td>

                                        <td>
                                            <input type="text" id="cCyclesFormText" name="sd" value="3">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Add</td>
                                        <td>
                                            <input type="text" id="cCyclesFormText" name="add" value="2">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Sub</td>
                                        <td>
                                            <input type="text" id="cCyclesFormText" name="sub" value="2">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Mul</td>
                                        <td>
                                            <input type="text" id="cCyclesFormText" name="mul" value="4">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Div</td>
                                        <td>
                                            <input type="text" id="cCyclesFormText" name="div" value="40">
                                        </td>
                                    </tr>

                                </tbody>
                            </table>

                        </div>

                        <div class="cFUnitSettings">
                            <table id="FUnitsCycleTable" class="cFUnitSettingsTable">
                                <thead>
                                    <tr>
                                        <th>F.Unit</th>
                                        <th>Number</th>
                                    </tr>

                                </thead>

                                <tbody id="FUnitSettingsTableBody">
                                    <tr>
                                        <td>Load/Store</td>
                                        <td>
                                            <input type="text" id="cUnitsFormText" name="FPLd" value="6">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Integer</td>
                                        <td>
                                            <input type="text" id="cUnitsFormText" name="FPAdd" value="4">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Multiplier</td>
                                        <td>
                                            <input type="text" id="cUnitsFormText" name="FPMul" value="2">
                                        </td>
                                    </tr>

                                </tbody>
                            </table>

                        </div>

                        <!-- <div class="cCacheSettings">
                            <table id="cacheCycleTable" class="cFUnitSettingsTable">
                                <thead>
                                    <tr>
                                        <th>OP (Cache)</th>
                                        <th>Miss Cycle</th>
                                        <th>Hit Cycle</th>
                                    </tr>

                                </thead>

                                <tbody id="CacheSettingsTableBody">
                                    <tr>
                                        <td>Load</td>
                                        <td>
                                            <input type="text" id="cCacheFormText" name="cacheMiss" value="2">
                                        </td>
                                        <td>
                                            <input type="text" id="cCacheFormText" name="cacheHit" value="0">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                        </div> -->

                        <div id="FUnitsInputActionButton" class="cFUnitsInputActionButton cInputActionButton">
                            <button class="cInstructionActionButton cNextButton" onclick="submitInput()">Submit</button>
                        </div>


                    </div>

                    <div id="Workload" class="cWorkload cInputBody" style="display:none" data-intro='Hello step one!'>
                        <canvas id="wLoadAntBox" style="display:none"></canvas>
                        <table id="WLoadTable" class="cWLoadTable">
                            <tbody id="WLoadTBody" class="cWLoadTBody">
                            </tbody>
                        </table>
                    </div>

                </div>

                <div id="dataContainer" class="cDataContainer">

                    <div class="cDataContainerTab cTab">
                        <button class="cDataContainerTabItem cTabButton cDataTab cDataTabShow"
                            onclick="showStatistics(event,'InEditor')">Dependency Graph</button>
                    </div>

                    <div id="statistics" class="cStatistics cDataBody">
                        <canvas id="graphCanvas" style="display:none"></canvas>
                        <button class="cDependendencyBtn" style="background-color: #e49d6a;"
                            onclick="showWAW()">WAW</button>
                        <button class="cDependendencyBtn" style="background-color: #c2da2c;"
                            onclick="showWAR()">WAR</button>
                        <button class="cDependendencyBtn" style="background-color: #cc5875; "
                            onclick="showRAW()">RAW</button>


                    </div>
                </div>

            </div> <!-- Left container end-->

            <div id="cContainer" class="cCContainer">

                <div id="cReservationContainer" class="cReservationContainer">

                    <div class="cReservationContainerTab cTab">
                        <button class="cReservationContainerTabItem cTabButton" onclick="placeholder()">Reservations
                            Units</button>
                    </div>

                    <div id="reservation" class="cReservation cReservationBody">
                        <canvas id="rsAntBox" style="display:none"></canvas>
                        <table id="RSTable" class="cRSTable">
                            <tbody id="RSTBody" class="cRSTBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="archContainer" class="cArchContainer">
                    <div class="cArchContainerTab cTab">
                        <button class="cArchContainerTabItem cTabButton" onclick="placeholder()">Architectural
                            Diagram</button>
                    </div>
                    <div id="architecture" class="cArchBody">
                        <canvas id="blockCanvas"></canvas>
                    </div>
                </div>
            </div>
            <!-- Center container end-->

            <div id="rContainer" class="cRContainer">

                <div id="cycle" class="cCycle">
                </div>

                <div id="jmpCycle" class="cJmpCycle">
                    <select id="jmpCycleSelection">
                    </select>
                </div>

                <div id="antCycles" class="cAntCycles">
                </div>

                <div id="ratContainer" class="cRatContainer">
                    <div class="cRatContainerTab cTab">
                        <button class="cRatContainerTabItem cTabButton cRatTab cRatTabShow"
                            onclick="placeholder()">RAT</button>
                    </div>
                    <div id="rat" class="cRatBody">
                        <canvas id="ratAntBox" style="display:none"></canvas>
                        <table id="RATable" class="cRATable">
                            <tbody id="RATBody" class="cRATBody">
                            </tbody>
                        </table>
                    </div>

                    <div id="scalerRat" class="cScalerRatBody">
                        <canvas id="scalerRatAntBox" style="display:none"></canvas>
                        <table id="scalerRATable" class="cScalerRATable">
                            <tbody id="scalerRATBody" class="cScalerRATBody">
                            </tbody>
                        </table>
                    </div>

                </div>


            </div>
            <!-- Right container end-->

            <div id="ftrContainer" class="cFooterContainer">
                <div id="actionButtonGroup" class="cActionButtonGroup">
                    <button type="button" id='intro' class="cActionBtn" onclick="ActivateIntro()">
                        <img src="resources/images/icons/intro.png">
                    </button>
                    <button type="button" id='stepBack' class="cActionBtn" onclick="executeStepBy(1)">
                        <img src="resources/images/icons/icons8-double-left-48.png">
                    </button>

                    <button type="button" id='stepAntBack' class="cActionBtn" onclick="execAnnotation(1)">
                        <img src="resources/images/icons/icons8-back-48.png">
                    </button>
                    <button type="button" id='stepAntForward' class="cActionBtn" onclick="execAnnotation(0)">
                        <img src="resources/images/icons/icons8-forward-48.png">
                    </button>
                    <button type="button" id='stepForward' class="cActionBtn" onclick="executeStepBy(0)">
                        <img src="resources/images/icons/icons8-double-right-48.png">
                    </button>


                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        const Direction = {
            "Forward": 0,
            "Backward": 1
        };

        Object.freeze(Direction);

        var mgtCtr = undefined;
        var GAnnotationCOunter = 0;

        function ShowComponents() {
            showInputTable();
            showRSView();
            showRAT();
            showWorkLoad();
            showCycle(0);
            showCycleSelection();
        }

        function ActivateIntro() {
            introJs().setOptions({
                steps: [
                    {
                        title: 'Welcome To Tomasulo Web Simulator',
                        intro: 'A web simulation tool to implement out-of-order dynamic scheduling algorithm',
                        position: 'right'
                    },
                    {
                        element: document.querySelector('#stepForward'),
                        intro: 'Execute to next instruction cycle',
                        position: 'top'
                    },
                    {
                        element: document.querySelector('#stepBack'),
                        intro: 'Execute to previous instruction cycle',
                        position: 'top'
                    },
                    {
                        element: document.querySelector('#stepAntForward'),
                        intro: 'Information shows what is happening in between cycle in forward fashion',
                        position: 'top'
                    },
                    {
                        element: document.querySelector('.cInputContainer'),
                        intro: 'Input window for instruction loading, configuration for functional units and cycle number ',
                        position: 'right'
                    },
                    {
                        element: document.querySelector('.cInputBody'),
                        intro: 'RISC-V instruction can be created by clocking \'+\' icon. ' +
                            'Instruction can be deleted by clicking delete icon. At this moment ' +
                            'Add, Sub, Mul, Div, Ld, Sd operations are supported.',
                        position: 'right'
                    },
                    {
                        element: document.querySelector('.cInputBody'),
                        intro: 'Load: reads input from file. ' +
                            'Test-*: predefined instruction input.   ' +
                            'Next: settings window',
                        position: 'right'
                    },
                    {
                        element: document.querySelector('.cDataContainer'),
                        intro: 'This window used for many purpose. Dependency graph, loop or branching instruction also place in this window',
                        position: 'right'
                    },
                    {
                        element: document.querySelector('.cReservationBody'),
                        intro: 'Algorithm execution window. ' +
                            '\"Time\": Remaining execution cycle ' +
                            '\"Busy\": Yes, if FU is occupied by an active instruction ' +
                            '\"OP\": Operation to perfume in the FU ' +
                            '\"Vj and Vk\": values of source operand ' +
                            '\"Qj and Qk\": Reservation station units that produce source values Vj and Vk ' +
                            '\"Busy\": Yes, if FU is occupied by an active instruction ' +
                            "\"Address\":  offset for load or store operation",
                        position: 'bottom'
                    },
                    {
                        element: document.querySelector('.cCycle'),
                        intro: 'Cycle Number',
                        position: 'left'
                    },
                    {
                        element: document.querySelector('.cAntCycles'),
                        intro: 'circle shows number of step remain till next cycle',
                        position: 'left'
                    },
                    {
                        element: document.querySelector('.cRatContainer'),
                        intro: 'Register address table; value denotes which FU will write to which register ',
                        position: 'left'
                    },]
            }).start();


        }


        function addLevelOption(id) {

            var selectList = document.createElement("select");
            selectList.id = id;
            var OPList = ["", "L1", "L2", "L3", "Jmp_L1", "Jmp_L2", "Jmp_L3"]
            for (var i = 0; i < OPList.length; i++) {
                var option = document.createElement("option");
                option.value = id + OPList[i];
                option.text = OPList[i];
                selectList.appendChild(option);
            }

            return selectList;
        }

        function markInstruction(id) {
            var elem = document.getElementById(id);
            var value = elem.options[elem.selectedIndex].text - 1;
            var inputTable = document.getElementById("insInputTable");
            var tBody = inputTable.tBodies[0];
            var rows = tBody.rows;

            for (let indx = 0; indx < rows.length; ++indx) {
                rows[indx].cells[0].style.backgroundColor = "";

            }

            rows[value].cells[0].style.backgroundColor = "#FF7F50";



        }

        function addRegSelectOption(id, opClass = "") {

            var selectList = document.createElement("select");
            selectList.id = id;
            var operandType = id.split("-")[0];
            var regIntValue = Array(32).fill('S').map((x, y) => (x + y));
            var regFloatValue = Array(32).fill('F').map((x, y) => (x + y));
            var numValues = [...Array(32).fill('+').map((x, y) => (x + y)),
            ...Array(32).fill('-').map((x, y) => (x + y))];

            var insCounter = Array(128).fill().map((x, y) => y);
            var regValueList = [...regFloatValue, ...regIntValue];
            var RegIntAndNumber = [...regIntValue, ...numValues];
            var regallValues = [...regValueList, ...numValues, ...insCounter];


            for (var i = 0; i < regallValues.length; i++) {
                var option = document.createElement("option");
                option.value = id + regallValues[i];
                option.text = regallValues[i];

                if (opClass == "Loader") {
                    if ((operandType == "Src2")) {
                        option.value = id + RegIntAndNumber[i];
                        option.text = RegIntAndNumber[i];
                    }
                }
                else if (opClass == "Branch") {
                    if ((operandType == "Dest") || (operandType == "Src1")) {
                        option.value = id + RegIntAndNumber[i];
                        option.text = RegIntAndNumber[i];
                    }
                    else if (operandType == "Src2") {
                        option.value = id + insCounter[i];
                        option.text = insCounter[i];
                        selectList.addEventListener('change', function () {
                            markInstruction(id);
                        }, false);
                    }

                }


                selectList.appendChild(option);
            }

            return selectList;
        }

        function addOPSelectOption(id, rowElem) {

            var selectList = document.createElement("select");
            selectList.id = id;

            selectList.addEventListener('change', function () {
                updateInputTableOperand(id, rowElem);
            }, false);
            var OPList = ["ADD", "SUB", "MUL", "DIV", "LD", "SD", "BNEQ"]

            for (var i = 0; i < OPList.length; i++) {
                var option = document.createElement("option");
                option.value = id + OPList[i];
                option.text = OPList[i];
                selectList.appendChild(option);
            }

            return selectList;
        }

        function createInputRow(tableElem) {
            var rowCount = tableElem.rows.length;
            if (rowCount > 0) {
                tableElem.deleteRow(rowCount - 1);
            }

            let row = document.createElement("tr");
            let rIndx = rowCount;
            for (let indx = 0; indx < 6; ++indx) {
                let cell = document.createElement("td");
                let value = undefined;

                switch (indx) {
                    case 0:
                        value = document.createTextNode(rIndx);
                        break;
                    case 1:
                        value = addOPSelectOption(("OP" + "-" + rIndx), row);
                        break;

                    case 2:

                        value = addRegSelectOption(("Dest" + "-" + rIndx));
                        break;

                    case 3:

                        value = addRegSelectOption(("Src1" + "-" + rIndx));
                        break;

                    case 4:
                        value = addRegSelectOption(("Src2" + "-" + rIndx));
                        break;

                    case 5:

                        value = document.createElement("button");
                        value.id = "rowButton";
                        value.innerHTML = '<img src="resources/images/icons/delete.png">';
                        value.addEventListener('click', function () {
                            tableElem.deleteRow(row.rowIndex - 1);
                        }, false);
                        break;
                }



                cell.appendChild(value);
                row.appendChild(cell);

            }
            tableElem.appendChild(row);
            createBtnsRow(tableElem);

            return row;
        }

        function createBtnsRow(tableElem) {

            let cell;
            let row = document.createElement("tr");
            for (let indx = 0; indx < 5; ++indx) {
                cell = document.createElement("td");
                row.appendChild(cell);
            }

            let btn = document.createElement("button");
            btn.id = "rowButton"
            btn.innerHTML = '<img src="resources/images/icons/add.png">';
            btn.addEventListener('click', function () {
                createInputRow(tableElem);
            }, false);
            cell = document.createElement("td");
            cell.appendChild(btn);
            row.appendChild(cell);
            tableElem.appendChild(row);
        }

        function selectOptionInCell(elem, value) {
            let options = elem.childNodes;
            for (let indx = 0; indx < options.length; ++indx) {

                if (options[indx].innerHTML.toLowerCase() == value) {
                    elem.selectedIndex = indx;
                    break;
                }
            }
        }

        function updateInputTableOperand(id, rowElem) {
            var elem = document.getElementById(id);
            var opName = elem.options[elem.selectedIndex].text;
            var opClass = getOPClass(opName);
            for (let indx = 0; indx < 3; ++indx) {
                var cell = rowElem.cells[2 + indx];
                var childNode = cell.childNodes[0];
                var operandID = childNode.id;
                cell.removeChild(childNode);
                var optionsElem = addRegSelectOption(operandID, opClass);
                cell.appendChild(optionsElem);

            }

            // selectOptionInCell(elem, opName);
        }
        function showAutoSelectionTable(instructions) {
            var inputTable = document.getElementById("insInputTable");
            var tBody = inputTable.tBodies[0];
            createBtnsRow(tBody); //maintenance only

            var rows = tBody.rows;
            while (rows.length > 1) {
                inputTable.deleteRow(1);
            }

            instructions.forEach(function (ins, indx) {
                let row = createInputRow(tBody);
                let cells = row.cells;
                let elem = undefined;
                let id = undefined;
                let opName = getUniqueOPName(ins.OP);
                for (let indx = 0; indx < 4; ++indx) {
                    switch (indx) {
                        case 0:
                            id = cells[1].childNodes[0].id;
                            elem = document.getElementById(id);
                            selectOptionInCell(elem, opName);
                            break;

                        case 1:
                            id = cells[2].childNodes[0].id;
                            elem = document.getElementById(id);
                            selectOptionInCell(elem, ins.Dest);
                            break;

                        case 2:
                            id = cells[3].childNodes[0].id;
                            elem = document.getElementById(id);
                            selectOptionInCell(elem, ins.Src1);
                            break;

                        case 3:
                            id = cells[4].childNodes[0].id;
                            elem = document.getElementById(id);
                            selectOptionInCell(elem, ins.Src2);
                            if (getOPClass(ins.OP) == "Branch") {
                                markInstruction(id);
                                document.getElementById(id).addEventListener('change', function () {
                                    markInstruction(id);
                                }, false);
                            }
                            break;
                    }
                }
            });

        }

        function addHeader(hdrElem, hdrList) {

            if (hdrList == undefined) {
                console.error("headers of " + hdrElem + "Empty");
                return;
            }

            let hdrRow = document.createElement("tr");
            hdrList.forEach(hdrElem => {
                let th = document.createElement("th");
                let thTxt = document.createTextNode(hdrElem);
                th.appendChild(thTxt);
                hdrRow.appendChild(th);
            });
            hdrElem.appendChild(hdrRow);
        }

        function completeTableCreation(tableId, hdrList) {
            var tableElem = document.getElementById(tableId);
            var tHead = tableElem.tHead;
            var tBody = tableElem.tBodies[0];

            if (tHead == null) {
                tHead = document.createElement('thead');
                addHeader(tHead, hdrList);
                tableElem.appendChild(tHead);
            }

            if (tBody == null) {
                tBody = document.createElement('tbody');
                tableElem.appendChild(tBody);
            }
        }

        function handleMouseOver(rowId, color) {
            console.log(rowId);
            if (rowId.length == 0) {
                return;
            }
            var elements = document.querySelectorAll(("#" + rowId));
            elements.forEach(element => {
                element.style.backgroundColor = color;
            });
        }

        function handleMouseOut(rowId) {
            if (rowId.length == 0) {
                return;
            }

            var elements = document.querySelectorAll(("#" + rowId));
            elements.forEach(element => {
                element.style.backgroundColor = "";
            });
        }

        function addTableRow(tBodyElem, cellsContentList, color = "", rowId = "") {
            var row = document.createElement("tr");
            row.id = rowId;

            cellsContentList.forEach(function (cellcontext, indx) {
                let cell = document.createElement("td");
                if (indx == 1) {
                    cell.style.backgroundColor = color;
                }
                let cellTxt = document.createTextNode(cellcontext);
                cell.appendChild(cellTxt);
                row.appendChild(cell);
            });
            row.addEventListener('mouseover', () => handleMouseOver(rowId, color));
            row.addEventListener('mouseout', () => handleMouseOut(rowId));
            tBodyElem.appendChild(row);

            return row;
        }

        function displayContents(contents) {
            var element = document.getElementById('file-content');
            element.textContent = contents;
        }

        function showRAW() {
            var wloadContent = mgtCtr.getWLoadContent();
            var dependencyList = mgtCtr.calculateDependency();
            drawDependencyGraph(dependencyList, "raw");
        }

        function showWAW() {
            var wloadContent = mgtCtr.getWLoadContent();
            var dependencyList = mgtCtr.calculateDependency();
            drawDependencyGraph(dependencyList, "waw");
        }

        function showWAR() {
            var wloadContent = mgtCtr.getWLoadContent();
            var dependencyList = mgtCtr.calculateDependency();
            drawDependencyGraph(dependencyList, "war");
        }

        function drawDependencyGraph(dependencyList, dependencyType = "") {
            var domElement = document.getElementById("statistics");
            var theCanvas = document.getElementById("graphCanvas");
            //theCanvas.style.display = "none";

            theCanvas.width = domElement.offsetWidth;
            theCanvas.height = domElement.offsetHeight;


            drawDependency(theCanvas, dependencyList, dependencyType);
            theCanvas.style.display = "block";
            theCanvas.style.position = "absolute";
            theCanvas.style.zIndex = 10;
        }

        function generateENV(instructions, execCycles, unitsSize) {
            mgtCtr = new ProcessManager();
            mgtCtr.setProcessEnv(instructions, execCycles, unitsSize);
            updateWLoad();
            updateRAT();
            updateScalerRAT();
            updateRSView();
            showCycle(0);
            mgtCtr.setTotalCycle();
            showCycleSelection();
        }

        function getScalerOperandValue(src1Ctx, src2Ctx) {
            closeModal();

            mgtCtr.updateScalerReg(src1Ctx[0], src1Ctx[1]);
            mgtCtr.updateScalerReg(src2Ctx[0], src2Ctx[1]);

            updateScalerRAT();

        }

        function popupModal(text) {
            document.getElementById('modalTop').style.display = "block";
            var modalForm = document.querySelector(".modalFormContent");
            modalForm.style.display = "block";
            modalForm.innerHTML = "";

            var divElem = document.createElement("div");
            divElem.setAttribute("id", "popTextDiv");
            var textNode = document.createTextNode(text);
            divElem.appendChild(textNode);
            modalForm.appendChild(divElem);
        }

        function updateScalerRegister(modalForm, selectList, src1, src2) {
            // Create a form dynamically
            var removeElem = document.getElementById("input4Reg");
            if (removeElem != null) {
                removeElem.remove();
            }

            var submitBtn = document.createElement("button");
            submitBtn.id = "input4Reg";
            submitBtn.innerHTML = "submit";
            submitBtn.addEventListener("click", (event) => {
                let src1 = document.getElementById("scalerRegSrc_1");
                let src2 = document.getElementById("scalerRegSrc_2");
                getScalerOperandValue([src1.getAttribute("name"), src1.value], [src2.getAttribute("name"), src2.value]);
            });

            let value = selectList.options[selectList.selectedIndex].value;

            removeElem = document.getElementById("scalerRegSrc_1");
            if (removeElem != null) {
                removeElem.remove();
            }

            // Create an input element for Full Name
            var elemSrc1 = document.createElement("input");
            elemSrc1.id = "scalerRegSrc_1";
            elemSrc1.className = "scalerRegister";
            elemSrc1.value = 80;
            elemSrc1.setAttribute("name", src1);
            elemSrc1.setAttribute("type", "text");
            elemSrc1.setAttribute("placeholder", src1);

            removeElem = document.getElementById("scalerRegSrc_2");
            if (removeElem != null) {
                removeElem.remove();
            }

            var elemSrc2 = document.createElement("input");
            elemSrc2.setAttribute("id", "scalerRegSrc_2");
            elemSrc2.className = "scalerRegister";
            elemSrc2.value = (80 - value * 8);
            elemSrc2.setAttribute("name", src2);
            elemSrc2.setAttribute("type", "text");
            elemSrc2.setAttribute("placeholder", src2);

            modalForm.appendChild(elemSrc1);
            modalForm.appendChild(elemSrc2);
            modalForm.appendChild(submitBtn);
        }

        function popupForScalerRegister(instruction) {

            document.getElementById('modalTop').style.display = "block";
            var modalForm = document.querySelector(".modalFormContent");
            modalForm.style.display = "block";
            modalForm.innerHTML = "";

            var src1 = instruction.Dest;
            var src2 = instruction.Src1;

            if (!isScalerRegister(src1) || !isScalerRegister(src2)) {
                popupModal(("No Scaler register or value for operands : " + src1 + " Or  " + src2));
                return 0;
            }

            popupModal("System has detected a branch instruction. Please enter number of iteration.");

            var itrLabel = document.createElement("Label");
            itrLabel.setAttribute("for", "itrLabel");
            itrLabel.innerHTML = "Iteration Count: ";
            modalForm.appendChild(itrLabel);

            var selectList = document.createElement("select");
            selectList.id = "itrLabel";
            selectList.addEventListener('change', function () {
                updateScalerRegister(modalForm, selectList, src1, src2);
            }, false);

            for (var i = 0; i <= 10; i++) {
                var option = document.createElement("option");
                option.value = i;
                option.text = i;
                selectList.appendChild(option);
            }

            modalForm.appendChild(selectList);
        }

        function closeModal() {
            document.getElementById('modalTop').style.display = 'none';
        }

        function checkForBranch(instruction) {

            for (let indx = 0; indx < instruction.length; ++indx) {
                if (getOPClass(instruction[indx].OP) == "Branch") {
                    if (indx == 0) {
                        popupModal("First Instruction can not be branch");
                    }
                    return indx;
                }
            }
            return 0;
        }


        function submitInput() {
            document.getElementById("wLoadAntBox").style.display = "none";
            document.getElementById("rsAntBox").style.display = "none";
            document.getElementById("ratAntBox").style.display = "none";
            var depBtns = document.querySelectorAll(".cDependendencyBtn");
            depBtns.forEach(element => {
                element.style.display = "block";
            });

            var instructions = collectInstructionsFromUI();
            var branchIndx = checkForBranch(instructions);
            if (branchIndx) {
                popupForScalerRegister(instructions[branchIndx]);
            }

            var execCycles = collectExecCycleFromUI();
            var unitsSize = collectUnitsSizeFromUI();

            if (((instructions == undefined) || (instructions.length == 0))
                ||
                ((execCycles == undefined) || (execCycles.length == 0))
                ||
                ((unitsSize == undefined) || (unitsSize.length == 0))
            ) {
                popupModal("Can not proceed because of input instruction or configuration empty");
                return;
            }


            generateENV(instructions, execCycles, unitsSize);
            TabSelection("Workload", "Workloads");
            var dependencyList = mgtCtr.calculateDependency();
            drawDependencyGraph(dependencyList);
            var unitsSize = collectUnitsSizeFromUI();
            var IQContent = mgtCtr.getIQContent();
            var rsContent = mgtCtr.getRSContent();
            var fpContent = mgtCtr.getFPContent();
            let insColors = mgtCtr.getAllInsColor();

            showCanvas(unitsSize, IQContent, rsContent, fpContent, insColors);
        }

        function clearInstruction() {
            var inputTable = document.getElementById("insInputTable");
            var rows = inputTable.rows;

            while (rows.length - 1 > 1) {
                inputTable.deleteRow(1);
            }
        }

        function updateScalerRAT() {
            var tableElem = document.getElementById("scalerRATable");
            var tBody = tableElem.tBodies[0];
            var rows = tableElem.rows;

            while (rows.length > 0) {
                tableElem.deleteRow(0);
            }

            var ratContentList = mgtCtr.getRATContent(RegType.Scaler);
            for (let indx = 0; indx < ratContentList.length; ++indx) {
                let ratContent = ratContentList[indx];
                let rowcontextList = [];

                rowcontextList.push(ratContent.Name);
                rowcontextList.push(ratContent.Qi);
                addTableRow(tBody, rowcontextList, ratContent.Color, ratContent.Hash);
            }

        }

        function updateRAT() {
            var tableElem = document.getElementById("RATable");
            var tBody = tableElem.tBodies[0];
            var rows = tableElem.rows;

            while (rows.length > 1) {
                tableElem.deleteRow(1);
            }

            var ratContentList = mgtCtr.getRATContent();
            for (let indx = 0; indx < ratContentList.length; ++indx) {
                let ratContent = ratContentList[indx];
                let rowcontextList = [];

                rowcontextList.push(ratContent.Name);
                rowcontextList.push(ratContent.Qi);
                addTableRow(tBody, rowcontextList, ratContent.Color, ratContent.Hash);
            }

        }

        function updateRSView() {
            var tableElem = document.getElementById("RSTable");
            var tBody = tableElem.tBodies[0];
            var rows = tableElem.rows;

            while (rows.length > 1) {
                tableElem.deleteRow(1);
            }

            var rsContentList = mgtCtr.getRSContent();
            for (let indx = 0; indx < rsContentList.length; ++indx) {
                let rsContent = rsContentList[indx];
                let rowcontextList = [];

                rowcontextList.push(rsContent.ReqCycle);
                rowcontextList.push(rsContent.Name);
                rowcontextList.push(rsContent.Status);
                rowcontextList.push(rsContent.Operator);
                rowcontextList.push(rsContent.Vj);
                rowcontextList.push(rsContent.Vk);
                rowcontextList.push(rsContent.Qj);
                rowcontextList.push(rsContent.Qk);
                rowcontextList.push(rsContent.Address);
                addTableRow(tBody, rowcontextList, rsContent.Color, rsContent.Hash);
            }

        }

        function highlighIssueInsOnly(rows, targetRow, color) {
            for (let indx = 0; indx < rows.length; ++indx) {
                rows[indx].style.backgroundColor = "";
            }
            targetRow.style.backgroundColor = color;
        }

        function updateWLoad() {

            var tableElem = document.getElementById("WLoadTable");
            var tBody = tableElem.tBodies[0];
            var rows = tableElem.rows;

            while (rows.length > 1) {
                tableElem.deleteRow(1);
            }

            var wLoads = mgtCtr.getWLoadContent();
            for (let indx = 0; indx < wLoads.length; ++indx) {
                let insLoad = wLoads[indx];
                let rowcontextList = [];

                rowcontextList.push(indx + 1);
                rowcontextList.push(insLoad.OP);
                let exeCycle = (isFinite(insLoad.CyExecution)) ? insLoad.CyExecution : "";
                rowcontextList.push(exeCycle);
                rowcontextList.push(insLoad.Dest);
                rowcontextList.push(insLoad.Src1);
                rowcontextList.push(insLoad.Src2);
                let issueCycle = (insLoad.CyIS == 0) ? "" : insLoad.CyIS;
                insLoad.CyExecEnd = (insLoad.CyExecEnd == 0) ? "" : insLoad.CyExecEnd;
                rowcontextList.push(issueCycle);
                CyExecStart = (insLoad.CyExecStart != 0) ? (insLoad.CyExecStart + "-" + insLoad.CyExecEnd) : "";
                rowcontextList.push(CyExecStart);
                let CyWBack = (insLoad.CyWBack == 0) ? "" : insLoad.CyWBack;
                rowcontextList.push(CyWBack);

                var row = addTableRow(tBody, rowcontextList, insLoad.Color, insLoad.Id);
                if (insLoad.StateType == StateType.Issue) {
                    highlighIssueInsOnly(tBody.rows, row, insLoad.Color);
                }
            }
        }

        function TabSelection(TabBodyID, TabId) {
            var i, x, tablinks;
            x = document.getElementsByClassName("cInputBody");
            for (i = 0; i < x.length; i++) {
                x[i].style.display = "none";
            }

            tablinks = document.getElementsByClassName("cInputContainerTabItem");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].style.backgroundColor = "";
            }

            document.getElementById(TabId).style.backgroundColor = "rgb(235, 190, 142)";

            var currentTabBody = document.getElementById(TabBodyID);
            currentTabBody.style.display = "block";
        }

        function hightlighAntCycle(cycleNumber) {
            var circles = document.querySelectorAll('#antCyclesEach');
            circles.forEach(function (element, indx) {
                if (indx == cycleNumber) {
                    element.style.backgroundColor = "green";
                }
            })
        }

        function showAntCycles(cycleCounts = 1) {
            var antCycleElem = document.getElementById("antCycles");
            var circles = document.querySelectorAll('#antCyclesEach');
            circles.forEach(element => {
                antCycleElem.removeChild(element);
            });

            var parentElemWidth = antCycleElem.clientWidth;

            for (let indx = 0; indx < cycleCounts; ++indx) {
                var circles = document.createElement('div');
                circles.id = "antCyclesEach";
                antCycleElem.appendChild(circles);

                if ((circles.clientWidth * cycleCounts) >= parentElemWidth) {
                    circles.style.width = (circles.clientWidth / 2) + "px";
                }
            }
        }

        function showCycle(cycleNum) {
            var divElem = document.getElementById("cycle");
            if (cycleNum < 10) {
                cycleNum = "0" + cycleNum;
            }
            divElem.textContent = cycleNum;
        }

        function jumpToCycle(targetCycle) {
            targetCycle = parseInt(targetCycle);
            targetCycle -= 1;
            mgtCtr.cycleInitStep();
            var indx = 0;
            while (indx < targetCycle) {
                mgtCtr.cycleStepForward();
                ++indx;
            }

            executeStepBy(direction = Direction.Forward)

        }

        function showCycleSelection() {
            var solutionCycle = 0;
            if (mgtCtr != undefined) {
                solutionCycle = mgtCtr.getTotalCycle();
            }
            var selectElem = document.getElementById("jmpCycleSelection");
            selectElem.innerHTML = "";
            var option = document.createElement("option");
            option.value = "jmp";
            option.text = "JUMP";
            selectElem.appendChild(option);

            var indx = 1;
            while (indx < solutionCycle) {
                option = document.createElement("option");
                option.value = indx;
                option.text = indx;

                selectElem.addEventListener('change', function () {
                    let select = document.getElementById('jmpCycleSelection');
                    let value = select.options[select.selectedIndex].value;
                    jumpToCycle(value);
                }, true);
                selectElem.appendChild(option);
                ++indx;
            }

        }

        function showRAT() {
            var hdrList = ["Register", "Value"];
            completeTableCreation("RATable", hdrList);
        }

        function showRSView() {
            var rsTable = document.getElementById("RSTable");
            var hdrList = ["Time", "Name", "Busy", "OP", "Src1 Vj", "Src2 Vk", "Src2 RS Qj", "Src2 RS Qk", "Address"]
            completeTableCreation("RSTable", hdrList);
        }

        function showWorkLoad() {
            var hdrList = ["#", "OP", "Exec Cycle", "Dest", "Src1", "Src2", "IS", "EX", "WB"];
            completeTableCreation("WLoadTable", hdrList);
        }


        function showInputTable() {
            var inputTable = document.getElementById("insInputTable");
            var tBody = inputTable.tBodies[0];
            var hdrList = ["#", "OP", "Dest", "Src1", "Src2", ""];
            completeTableCreation("insInputTable", hdrList);
            createBtnsRow(tBody);
        }

        function ShowFunitSettings() {
            TabSelection("FUnitsInput", "Funits");
        }

        function placeholder() {
            /*
                this is a placeholder for function that are triggered based on user action
            */
            return 0;
        }

        function getRSViewRowPosition(insNumber) {
            --insNumber;
            var wLoads = mgtCtr.getWLoadContent();
            var insHash = wLoads[insNumber].Id;
            var tableElem = document.getElementById("RSTable");
            var tBody = tableElem.tBodies[0];
            var rows = tableElem.rows;

            let indx = 0;
            while (indx < rows.length) {
                if (rows[indx].id == insHash) {
                    break;
                }
                ++indx;
            }

            return indx;

        }

        function getRATRowPosition(insNumber) {
            --insNumber;
            var wLoads = mgtCtr.getWLoads();
            var insHash = wLoads[insNumber].getID();
            var rsType = getRSType(wLoads[insNumber].operator);
            var rsName = mgtCtr.getRsName(rsType, insHash);
            let regName = mgtCtr.getRegName(rsName);

            var tableElem = document.getElementById("RATable");
            var tBody = tableElem.tBodies[0];
            var rows = tableElem.rows;

            let indx = 0;

            while (indx < rows.length) {
                if (rows[indx].cells[0].innerText == regName) {
                    break;
                }
                ++indx;
            }

            return indx;
        }

        function executeStepBy(direction = Direction.Forward) {
            document.getElementById("wLoadAntBox").style.display = "none";
            document.getElementById("rsAntBox").style.display = "none";
            document.getElementById("ratAntBox").style.display = "none";
            GAnnotationCOunter = 0;
            if (mgtCtr == undefined) {
                return;
            }

            let cycleNum = 0;
            if (direction == Direction.Forward) {
                cycleNum = mgtCtr.cycleStepForward();
            }
            else {
                cycleNum = mgtCtr.cycleStepBack();
            }

            if (cycleNum < 0) {
                return;
            }
            updateRSView();
            updateRAT();
            updateScalerRAT();
            updateWLoad();
            showCycle(cycleNum);

            var IQContent = mgtCtr.getIQContent();
            var rsContent = mgtCtr.getRSContent();
            var fpContent = mgtCtr.getFPContent();
            var insColors = mgtCtr.getAllInsColor();
            showCanvas(collectUnitsSizeFromUI(), IQContent, rsContent, fpContent, insColors);

            showAntCycles(mgtCtr.getInsAnnotationCount());

        }

        function getOffset(el) {
            var _x = 0;
            var _y = 0;
            while (el && !isNaN(el.offsetLeft) && !isNaN(el.offsetTop)) {
                _x += el.offsetLeft - el.scrollLeft;
                _y += el.offsetTop;
                el = el.offsetParent;
            }
            return { top: _y, left: _x };
        }

        function ScrollToElement(theElement, posY) {

            var selectedPosX = 0;
            var selectedPosY = posY;

            theElement.scrollTo(selectedPosX, selectedPosY);
        }

        function prepareAntBox(domElement, theCanvas, tableElem, message, rowNumber, points2Cell) {


            var LTX = 0;
            var LTY = 0;

            LTY = (tableElem.rows[0].cells[0]).clientHeight;

            var cell = (tableElem.rows[1].cells[0]);
            var cellHeight = cell.clientHeight;
            var cellWidth = cell.clientWidth;
            var elemVisibleRows = (domElement.offsetHeight / cell.offsetHeight) - 2;

            var points2X = LTX + points2Cell * (cellWidth) + (cellWidth / 2);
            var points2Y = LTY + rowNumber * (cellHeight);

            var boxPosX = domElement.clientWidth * 0.25;
            var boxPosY = LTY + (cellHeight * rowNumber) + (cellHeight * 1.5);

            theCanvas.width = domElement.offsetWidth;
            theCanvas.height = domElement.offsetHeight;


            if (boxPosY > (domElement.offsetHeight * 0.75)) {
                boxPosY = LTY + cellHeight;
            }

            if (points2Y > (elemVisibleRows * cellHeight)) {
                var rowScrolledInPix = points2Y - (elemVisibleRows * cellHeight);
                ScrollToElement(domElement, rowScrolledInPix);
                points2Y = (points2Y - rowScrolledInPix);

            }
            else {
                ScrollToElement(domElement, 0);
            }
            drawAntBox(theCanvas, boxPosX, boxPosY, message, points2X, points2Y);
            theCanvas.style.display = "block";
            theCanvas.style.position = "absolute";
            theCanvas.style.zIndex = 10;
        }

        var GlobalSpace = {};
        function saveAntProperty(domElement, theCanvas, tableElem, message, rowNumber, points2Cell) {
            GlobalSpace["domElement"] = domElement;
            GlobalSpace["canvasElement"] = theCanvas;
            GlobalSpace["tableElement"] = tableElem;
            GlobalSpace["message"] = message;
            GlobalSpace["rowNumber"] = rowNumber;
            GlobalSpace["column"] = points2Cell;
        }

        function resetAntPropertx() {
            GlobalSpace["domElement"] = undefined;
            GlobalSpace["canvasElement"] = undefined;
            GlobalSpace["tableElement"] = undefined;
            GlobalSpace["message"] = undefined;
            GlobalSpace["rowNumber"] = undefined;
            GlobalSpace["column"] = undefined;
        }

        function getAntProperty() {
            return GlobalSpace;
        }

        function execAnnotation(direction = Direction.Forward) {
            document.getElementById("wLoadAntBox").style.display = "none";
            document.getElementById("rsAntBox").style.display = "none";
            document.getElementById("ratAntBox").style.display = "none";


            var obj;
            if (direction == Direction.Forward) {
                obj = mgtCtr.forwardAnnotation();
                if (obj == undefined || obj.ant.length == 0) {
                    return executeStepBy(Direction.Forward);
                }
            }
            else {
                obj = mgtCtr.backwardAnnotation();
                if (obj == undefined || obj.ant.length == 0) {
                    return executeStepBy(Direction.Backward);
                }
            }

            var antElem, canvasId, tableId;
            var annotations = obj.ant;
            var color = obj.color;
            var rowNumber;
            for (let indx = 0; indx < annotations.length; ++indx) {

                switch (annotations[indx].resourceType) {
                    case ResourceType.WorkLoad:
                        antElem = document.getElementById("Workload");
                        canvasId = document.getElementById("wLoadAntBox");
                        tableId = document.getElementById("WLoadTable");
                        rowNumber = annotations[indx].row;
                        break;

                    case ResourceType.RSUnits:
                        antElem = document.getElementById("reservation");
                        canvasId = document.getElementById("rsAntBox");
                        tableId = document.getElementById("RSTable");
                        rowNumber = getRSViewRowPosition(annotations[indx].row);
                        break;

                    case ResourceType.RAT:
                        antElem = document.getElementById("rat");
                        canvasId = document.getElementById("ratAntBox");
                        tableId = document.getElementById("RATable");
                        rowNumber = getRATRowPosition(annotations[indx].row);
                        break;

                    default:
                        break;
                }

                prepareAntBox(antElem, canvasId, tableId,
                    annotations[indx].message,
                    rowNumber,
                    annotations[indx].pointsTo);

                hightlighAntCycle(GAnnotationCOunter);
            }
            GAnnotationCOunter++;

        }

    </script>
    _x

</body>

</html>